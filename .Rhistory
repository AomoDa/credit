sf = get_grow_score_func(rule)
df
sf
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date))
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s))
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s))
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
hist(a$s)
View(a)
rule
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))%>%
inner_join(coef_dat)
View(aa)
rule
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(mm_sx = sum(mm_sx*coef,na.rm=TRUE))
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(mm_sx = sum(mm_sx*coef,na.rm=TRUE))
sum(aa$mm_sx)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(mm_sx = sum(mm_sx*coef,na.rm=TRUE)) %>%
mutate(s = sf(mm_sx))
rule
source("env.R")
rule=env$business$mm$mm_sx
rule
rule=env$business$mm$mm_sx
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
coef_dat
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_sx) %>%
mutate(s_mon = sf(mm_sx))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
rule=env$business$mm$mm_zk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk) %>%
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk)
rule=env$business$mm$mm_zk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk) %>%
mutate(s_mon = sf(mm_zk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk) %>%
mutate(s_mon = sf(mm_zk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
source("env.R")
rule=env$business$mm$mm_zk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk) %>%
mutate(s_mon = sf(mm_zk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk) %>%
mutate(s_mon = sf(mm_zk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
hist(aa$s)
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_zk)
table(a$mm_zk)
rule=env$business$mm$mm_csk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_csk) %>%
mutate(s_mon = sf(mm_csk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_csk) %>%
mutate(s_mon = sf(mm_csk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
hist(a$s)
rule=env$business$mm$mm_cdk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_cdk) %>%
mutate(s_mon = sf(mm_cdk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_cdk) %>%
mutate(s_mon = sf(mm_cdk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
hist(a$s)
rule=env$business$mm$mm_fxz
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_fxz) %>%
mutate(s_mon = sf(mm_fxz))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_fxz) %>%
mutate(s_mon = sf(mm_fxz))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
hist(a$s)
rule=env$business$mm$mm_wt
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_wt) %>%
mutate(s_mon = sf(mm_wt))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_wt) %>%
mutate(s_mon = sf(mm_wt))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
hist(a$s)
rule=env$business$mm$mm_ys
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_ys) %>%
mutate(s_mon = sf(mm_ys))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,mm_ys) %>%
mutate(s_mon = sf(mm_ys))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
hist(a$s)
rule=env$business$zl$zl_sfg
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_sfg) %>%
mutate(s_mon = sf(zl_sfg))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_sfg) %>%
mutate(s_mon = sf(zl_sfg))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
aa$s
hist(aa$s)
View(aa)
rule
source("env.R")
rule=env$business$zl$zl_sfg
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_sfg) %>%
mutate(s_mon = sf(zl_sfg))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
aa=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_sfg) %>%
mutate(s_mon = sf(zl_sfg))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
hist(aa$s)
rule=env$business$zl$zl_cfg
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
# 得分方法
sf = get_grow_score_func(rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_cfg) %>%
mutate(s_mon = sf(zl_cfg))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule=env$business$zl$zl_pzsk
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
select(date,id,zl_pzsk) %>%
mutate(s_mon = sf(zl_pzsk))%>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(s_mon*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule=env$business$zl$zl_wt
source("env.R")
rule=env$business$zl$zl_zg
# 得分方法
sf = get_grow_score_func(rule)
# 计算
dat %>%
filter(date == now_date) %>%
select(id,zl_zg)%>%
group_by(id) %>%
summarise(zl_zg=sum(zl_zg,na.rm=TRUE)) %>%
mutate(s=sf(zl_zg)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
select(id,s) %>%
as.data.frame()
a=	dat %>%
filter(date == now_date) %>%
select(id,zl_zg)%>%
group_by(id) %>%
summarise(zl_zg=sum(zl_zg,na.rm=TRUE)) %>%
mutate(s=sf(zl_zg)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
select(id,s) %>%
as.data.frame()
View(a)
hist(a)
hist(a$s)
rule
rule=env$business$zl$zl_wt
# 得分方法
sf = get_grow_score_func(rule)
# 计算
dat %>%
filter(date == now_date) %>%
select(id,zl_wt)%>%
group_by(id) %>%
summarise(zl_wt=sum(zl_wt,na.rm=TRUE)) %>%
mutate(s=sf(zl_wt)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
select(id,s) %>%
as.data.frame()
a=	dat %>%
filter(date == now_date) %>%
select(id,zl_wt)%>%
group_by(id) %>%
summarise(zl_wt=sum(zl_wt,na.rm=TRUE)) %>%
mutate(s=sf(zl_wt)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
select(id,s) %>%
as.data.frame()
hist(a$s)
rule=env$business$zl$deal
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
group_by(id,date) %>%
summarise(zl_cj = rule$score$zl_0 * sum(zl_cj,na.rm=TRUE),
zl_1 = rule$score$zl_1 * sum(zl_1,na.rm=TRUE)) %>%
mutate(zl = zl_cj + zl_1) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(zl*coef)) %>%
ungroup()%>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
la=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
group_by(id,date) %>%
summarise(zl_cj = rule$score$zl_0 * sum(zl_cj,na.rm=TRUE),
zl_1 = rule$score$zl_1 * sum(zl_1,na.rm=TRUE)) %>%
mutate(zl = zl_cj + zl_1) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(zl*coef)) %>%
ungroup()%>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
a=	dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
group_by(id,date) %>%
summarise(zl_cj = rule$score$zl_0 * sum(zl_cj,na.rm=TRUE),
zl_1 = rule$score$zl_1 * sum(zl_1,na.rm=TRUE)) %>%
mutate(zl = zl_cj + zl_1) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(zl*coef)) %>%
ungroup()%>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
rule
table(a$s)
rule
rule=env$business$mm$deal
rule
rule=env$business$mm$deal
# 提取计算周期 & 系数
coef_dat=getCoefData(dat = dat,now_date = now_date,rule = rule)
dat %>%
filter(date <= now_date) %>%
filter(date >= min(coef_dat$date)) %>%
group_by(id,date) %>%
summarise(mm_2 = rule$score$mm_2 * sum(mm_2,na.rm=TRUE),
mm_1 = rule$score$mm_1 * sum(mm_1,na.rm=TRUE)) %>%
mutate(mm = mm_1 + mm_2) %>%
inner_join(coef_dat)  %>%
group_by(id) %>%
summarise(s=sum(mm*coef)) %>%
mutate(s=if_else(s>=rule$total,rule$total,s)) %>%
as.data.frame()
runApp()
runApp()
runApp()
runApp()
runApp()
a
a
