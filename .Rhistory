sdat=credit_mm_wt(kpi.dat,env=env,now_date=now_date))
rlt$mm_ys = credit_score(id=rlt$id,
sdat=credit_mm_ys(kpi.dat,env=env,now_date=now_date))
# 汇总
rlt$mm = rlt$mm_s_sx + rlt$mm_c_sx + rlt$mm_zk + rlt$mm_cxz +
rlt$mm_cdk +rlt$mm_fxz + rlt$mm_wt + rlt$mm_ys
log_info("End - 买卖指标")
#----------------------------------------------------------------
# 业务能力 - 租赁
#----------------------------------------------------------------
log_info("Start - 租赁指标")
# 收房管
rlt$zl_sfg = credit_score(id=rlt$id,
sdat=credit_zl_sfg(kpi.dat,env=env,now_date=now_date))
# # 合作出房
rlt$zl_fhz = credit_score(id=rlt$id,
sdat=credit_zl_fhz(kpi.dat,env=env,now_date=now_date))
# 出着火房管
rlt$zl_czh = credit_score(id=rlt$id,
sdat=credit_zl_czh(kpi.dat,env=env,now_date=now_date))
# 在管量 、委托
rlt$zl_zg = credit_score(id=rlt$id,
sdat=credit_zl_zg(kpi.dat,env=env,now_date=now_date))
rlt$zl_wt = credit_score(id=rlt$id,
sdat=credit_zl_wt(kpi.dat,env=env,now_date=now_date))
# 首看新增客户 、房源新增、普租实勘
rlt$zl_cxz = credit_score(id=rlt$id,
sdat=credit_zl_cxz(kpi.dat,env=env,now_date=now_date))
rlt$zl_fxz = credit_score(id=rlt$id,
sdat=credit_zl_fxz(kpi.dat,env=env,now_date=now_date))
rlt$zl_pzsk = credit_score(id=rlt$id,
sdat=credit_zl_pzsk(kpi.dat,env=env,now_date=now_date))
log_info("End - 租赁指标")
# 汇总
rlt$zl = rlt$zl_sfg + rlt$zl_fhz + rlt$zl_czh + rlt$zl_zg +
rlt$zl_wt +  rlt$zl_cxz + rlt$zl_fxz + rlt$zl_pzsk
return(rlt)
}
# 计算历史全部
run <- function(kpi.dat,gg.dat,env) {
order_date = sort(unique(kpi.dat$date))
for (i in seq_len(length(order_date))) {
if(i==1){
rlt = run_mon(kpi.dat,gg.dat,
now_date=order_date[i],env=env)
}else{
tmp = run_mon(kpi.dat,gg.dat,
now_date=order_date[i],env=env,
last_dat=rlt[rlt$credit_date==order_date[i-1],])
rlt = rbind(rlt,tmp)
}
}
# 关联经纪人身份
rlt$business_type = ifelse(str_count(rlt$qu,pattern = "A"),"zl","mm")
# 处理错误数据
rlt$zl[rlt$business_type=="mm"] = 0
rlt$mm[rlt$business_type=="zl"] = 0
rlt$score = rlt$base + rlt$behavior + rlt$service +
rlt$contribute + rlt$gw + rlt$mm + rlt$zl
rlt$entry_date_num = as.numeric(substr(rlt$entry_date,1,4)) * 12 + as.numeric(substr(rlt$entry_date,6,7))
rlt$data_date_num = as.numeric(substr(rlt$credit_date,1,4)) * 12 + as.numeric(substr(rlt$credit_date,6,7))
rlt$entry_month = rlt$data_date_num - rlt$entry_date_num
return(rlt)
}
finalScore = run(kpi.dat,gg.dat,env)
write.csv(x = finalScore,file = "finalScore.csv",row.names =FALSE)
str(finalScore)
now_date
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type="mm") %>%
ggplot(aes(x=qu,y=score)) + geom_boxplot()
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
ggplot(aes(x=qu,y=score)) + geom_boxplot()
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
ggplot(aes(x=daqu,y=score)) + geom_boxplot()
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
ggplot(aes(x=daqu,y=score)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
ggplot(aes(x=daqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))
45
finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
ggplot(aes(x=daqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
?reorder
tmp= finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
select(daqu,score)
rdaqu = with(tmp,reorder(daqu,score,mendian))
ggplot(data=tmp,aes(x=dardaququ,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
tmp= finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
select(daqu,score)
rdaqu = with(tmp,reorder(daqu,score,median))
ggplot(data=tmp,aes(x=dardaququ,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
ggplot(data=tmp,aes(x=rdaqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
tmp= finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
select(daqu,score)
rdaqu = with(tmp,reorder(daqu,-score,median))
ggplot(data=tmp,aes(x=rdaqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
tmp= finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="mm") %>%
select(daqu,score)
rdaqu = with(tmp,reorder(daqu,-score,median))
p1 = ggplot(data=tmp,aes(x=rdaqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("各项指标分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
ggplotly(p1)
tmp= finalScore %>%
filter(credit_date == now_date) %>%
filter(business_type=="zl") %>%
select(daqu,score)
rdaqu = with(tmp,reorder(daqu,-score,median))
p1 = ggplot(data=tmp,aes(x=rdaqu,y=score,fill=daqu)) + geom_boxplot()+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分大区分布: ",now_date))+
theme(axis.text.x = element_text(angle=45))
ggplotly(p1)
names(finalScore)
tmp= finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
ggplot(aes(x=entry_month,y=score) + geom_boxplot()
tmp= finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
ggplot(aes(x=entry_month,y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
ggplot(aes(x=entry_month,y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
ggplot(aes(x=as.factor(entry_month),y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=48,48,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="mm") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="zl") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score)) + geom_boxplot()
finalScore %>%
filter(business_type=="zl") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score)) + geom_boxplot()	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))
finalScore %>%
filter(business_type=="zl") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) + geom_boxplot()	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))
finalScore %>%
filter(business_type=="zl") %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) + geom_boxplot()	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
plot_score_new_user_mm <- function(bty="mm") {
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) + geom_boxplot()	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
}
plot_score_new_user_mm()
plot_score_new_user_mm(bty = "zl")
?geom_boxplot
plot_score_new_user_mm <- function(bty="mm") {
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notch=TRUE)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
}
?geom_boxplot
plot_score_new_user_mm(bty = "zl")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
runApp()
runApp()
runApp()
write.csv(x = finalScore,file = "finalScore.csv",row.names =FALSE)
runApp()
plot_score_new_user_mm <- function(bty="mm") {
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
}
plot_score_new_user_mm()
a=finalScore %>%
filter(business_type==bty)
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))%>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score)
str(finalScore)
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month=if_else(entry_month>=24,24,entry_month))
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(xx=if_else(entry_month>=24,24,entry_month))
if_else
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score)
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(entry_month >= 24)
entry_month
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(xx=if_else(entry_month >= 24,24,entry_month))
summary(finalScore$entry_month)
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(xx=if_else(entry_month >= 24,24,entry_month))
dplyr::if_else()
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
mutate(xx=dplyr::if_else(entry_month >= 24,24,entry_month))
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
# mutate(xx=dplyr::if_else(entry_month >= 24,24,entry_month))    %>%
ggplot(aes(x=as.factor(xx),y=score,fill=xx)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
# mutate(xx=dplyr::if_else(entry_month >= 24,24,entry_month))    %>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
ggplot(aes(x=as.factor(entry_month),y=score,fill=entry_month)) +
geom_boxplot(notchwidth=0)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势:买卖"))+
scale_fill_distiller(palette = "Spectral")
runApp()
runApp()
runApp()
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=as.factor(entry_month),y=score)) +
geom_line(col=I("red"))	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=I("red"))	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=I("red"))	+
geom_point(col=I("red"))	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
?pch
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=I("red"))	+
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
runApp()
finalScore$score[finalScore$business_type==bty & finalScore$credit_date==as.Date("2021-03-01")]
?quietly
quantile(s,0.25)
sm = median(s)
sm_l = quantile(s,0.25)
sm_u = quantile(s,0.75)
s = finalScore$score[finalScore$business_type==bty & finalScore$credit_date==as.Date("2021-03-01")]
sm = median(s)
sm_l = quantile(s,0.25)
sm_u = quantile(s,0.75)
?geom_line
geom_abline()
?geom_abline
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_abline(h=sm) +
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_abline(aes(h=sm)) +
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_abline(yintercept=sm,col=I("blue"),lty=3) +
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_hline(yintercept=sm,col=I("blue"),lty=3) +
geom_point(col=I("red"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
s = finalScore$score[finalScore$business_type==bty & finalScore$credit_date==as.Date("2021-03-01")]
sm = median(s)
sm_l = quantile(s,0.25)
sm_u = quantile(s,0.75)
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line(col=gray(0.5))	+
geom_hline(yintercept=sm,col=I("red"),lty=2) +
geom_hline(yintercept=sm_l,col=I("blue"),lty=2) +
geom_hline(yintercept=sm_u,col=I("blue"),lty=2) +
geom_point(col=I("orange"),pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
s = finalScore$score[finalScore$business_type==bty & finalScore$credit_date==as.Date("2021-03-01")]
sm = median(s)
sm_l = quantile(s,0.25)
sm_u = quantile(s,0.75)
a=finalScore %>%
filter(business_type==bty) %>%
select(entry_month,score) %>%
filter(entry_month<=24)  %>%
group_by(entry_month) %>%
summarise(score=median(score,na.rm=TRUE)) %>%
ggplot(aes(x=entry_month,y=score)) +
geom_line()	+
geom_hline(yintercept=sm,col=I("red"),lty=2) +
geom_hline(yintercept=sm_l,col=I("blue"),lty=2) +
geom_hline(yintercept=sm_u,col=I("blue"),lty=2) +
geom_point(pch=5)	+
theme_bw() +  theme(text= element_text(family="STXihei")) +
labs(x="",y="分",title=paste0("信用分成长趋势"))+
scale_fill_distiller(palette = "Spectral")
ggplotly(a)
runApp()
